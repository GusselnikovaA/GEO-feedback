ymaps.ready(init);let storage=localStorage,feedbackArray=[];function init(){const e=ymaps.templateLayoutFactory.createClass('\n        <div class="feedback">\n            <header class="feedback__header">\n                <div class="feedback__geo"><img src="img/location.png" alt="location"></div>\n                <div class="feedback__address">$[properties.address]</div>\n                <button class="feedback__close"><img src="img/close.png" alt="close"></img></button>\n            </header>\n            <div class="feedback-content">\n                <div class="feedback-list">\n                    {% if (properties.feedbackArray.length == 0) %}\n                        <div class="feedback__text feedback__none">Отзывов пока нет...</div>\n                    {% else %}\n                        <ul>\n                        {% for item in properties.feedbackArray %}\n                            <li>\n                                <span class="feedback__name">$[item.name]</span>\n                                <span class="feedback__location">$[item.location]</span>\n                                <span class="feedback__date">$[item.date]</span>\n                                <div class="feedback__text">$[item.feedback]</div>\n                            </li>\n                        {% endfor %}\n                        </ul>\n                    {% endif %}\n                </div>\n                <form class="feedback-form" action="#">\n                    <h1 class="feedback-form__title">ВАШ ОТЗЫВ</h1>\n                    <input type="text" class="feedback-form__input feedback-form__name" placeholder="Ваше имя">\n                    <input type="text" class="feedback-form__input feedback-form__location" placeholder="Укажите место">\n                    <textarea class="feedback-form__input feedback-form__text" rows="6" placeholder="Поделитесь впечатлениями"></textarea>\n                    <button class="feedback-form__button" id="add">Добавить</button>\n                </form>\n            </div>\n        </div>\'',{build:function(){e.superclass.build.call(this),this._element=this.getParentElement().querySelector(".feedback"),this.applyElementOffset();const t=document.querySelector(".feedback-form__button"),a=document.querySelector(".feedback__close"),s=document.querySelector(".feedback-list");s.scrollTop=s.scrollHeight,t.addEventListener("click",e=>{e.preventDefault(),this.addFeedback()}),a.addEventListener("click",()=>{this.onCloseClick()})},clear:function(){const t=document.querySelector(".feedback-form__button"),a=document.querySelector(".feedback__close");t.removeEventListener("click",()=>{this.addFeedback()}),a.removeEventListener("click",()=>{this.onCloseClick()}),e.superclass.clear.call(this)},applyElementOffset:function(){this._element.style.left=this._element.offsetLeft+"px",this._element.style.top=this._element.offsetTop+"px"},onCloseClick:function(){this.events.fire("userclose")},getShape:function(){if(!this._element)return e.superclass.getShape.call(this);var t=getComputedStyle(this._element),a={left:parseFloat(t.left),top:parseFloat(t.top)};return new ymaps.shape.Rectangle(new ymaps.geometry.pixel.Rectangle([[a.left,a.top],[a.left+this._element.offsetWidth,a.top+this._element.offsetHeight]]))},addFeedback:async function(e){const t=document.querySelector(".feedback-form__name"),a=document.querySelector(".feedback-form__location"),s=document.querySelector(".feedback-form__text"),o=new Date;let r=this._data.properties.coords,d=this._data.properties.address,c={};if(console.log("new data",this.getData().properties),this.getData().properties._data&&(this.getData().properties._data.point?(this.getData().properties._data.feedbackArray=[],r=this.getData().properties._data.point.reverse(),d=this._data.properties._data.address):(r=this._data.properties._data.coords,d=this._data.properties._data.address)),""==t.value||""==a.value||""==s.value)return void alert("Заполните все поля!");try{storage.data=JSON.stringify({coords:r,address:d,name:t.value,location:a.value,feedback:s.value,date:o.toLocaleDateString()+" "+o.toLocaleTimeString()})}catch(e){console.error("Не удалось сохранить данные")}let n=JSON.parse(storage.data||"{}");feedbackArray.push(n),c=this.getData().properties._data?this.getData().properties._data.feedbackArray:this.getData().properties.feedbackArray,c.push({address:d,name:n.name,location:n.location,feedback:n.feedback,date:n.date}),await this.setData({properties:{address:d,coords:r,feedbackArray:c}}),t.value="",a.value="",s.value="",this.addPoint()},addPoint:function(e){const a=this._data.properties.coords,o=this._data.properties.address;feedbackArray.forEach(e=>{if(e==feedbackArray[feedbackArray.length-1]){const r=new ymaps.Placemark(a,{coords:a,address:o,feedbackArray:[{name:e.name,location:e.location,feedback:e.feedback,date:e.date}]},{preset:"islands#orangeIcon"});t.geoObjects.add(r),s.add(r)}})}}),t=new ymaps.Map("map",{center:[59.94,30.32],zoom:12,controls:["zoomControl"],behaviors:["drag"]},{balloonLayout:e}),a=ymaps.templateLayoutFactory.createClass('\n    {% for item in properties.feedbackArray %}\n    <div class="cluster">\n        <div class="cluster__header">\n            <div class="cluster__location">$[item.location]</div>\n            <div class="cluster__address"><a class="search_by_address">$[properties.address]</a></div>\n        </div>\n        <div class="cluster__feedback">$[item.feedback]</div>\n        <div class="cluster__date">$[item.date]</div>\n    </div> \n    {% endfor %}\n    '),s=new ymaps.Clusterer({preset:"islands#invertedOrangeClusterIcons",clusterBalloonContentLayout:"cluster#balloonCarousel",balloonLayout:"islands#balloon",clusterBalloonItemContentLayout:a,clusterBalloonPanelMaxMapArea:0,clusterBalloonPagerSize:5,groupByCoordinates:!1,clusterDisableClickZoom:!0,clusterHideIconOnBalloonOpen:!1});t.geoObjects.add(s),t.events.add("click",(function(e){const a=e.get("coords");ymaps.geocode(a).then((function(e){const s=e.geoObjects.get(0);let o={};o.coords=a,o.address=s.properties.get("text"),o.feedback=[],t.balloon.open(a,{properties:{coords:o.coords,address:o.address,feedbackArray:o.feedback}})}))})),document.addEventListener("click",e=>{let a=e.target,s=[];"search_by_address"===a.className&&(e.preventDefault(),feedbackArray.forEach(e=>{a.text===e.address&&(s.push(e),coords=e.coords,address=e.address),e==feedbackArray[feedbackArray.length-1]&&t.balloon.open(coords,{properties:{address:address,coords:coords,feedbackArray:s}})}))})}