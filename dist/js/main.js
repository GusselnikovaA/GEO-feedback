ymaps.ready(init);let storage=localStorage,feedbackArray=[];function init(){const e=ymaps.templateLayoutFactory.createClass('\n        <div class="feedback">\n            <header class="feedback__header">\n                <div class="feedback__geo"><img src="img/location.png" alt="location"></div>\n                <div class="feedback__address">$[properties.address]</div>\n                <button class="feedback__close"><img src="img/close.png" alt="close"></img></button>\n            </header>\n            <div class="feedback-content">\n                <div class="feedback-list">\n                    {% if (properties.feedbackArray.length == 0) %}\n                        <div class="feedback__text feedback__none">Отзывов пока нет...</div>\n                    {% else %}\n                        <ul>\n                        {% for item in properties.feedbackArray %}\n                            <li>\n                                <span class="feedback__name">$[item.name]</span>\n                                <span class="feedback__location">$[item.location]</span>\n                                <span class="feedback__date">$[item.date]</span>\n                                <div class="feedback__text">$[item.feedback]</div>\n                            </li>\n                        {% endfor %}\n                        </ul>\n                    {% endif %}\n                </div>\n                <form class="feedback-form" action="#">\n                    <h1 class="feedback-form__title">ВАШ ОТЗЫВ</h1>\n                    <input type="text" class="feedback-form__input feedback-form__name" placeholder="Ваше имя">\n                    <input type="text" class="feedback-form__input feedback-form__location" placeholder="Укажите место">\n                    <textarea class="feedback-form__input feedback-form__text" rows="6" placeholder="Поделитесь впечатлениями"></textarea>\n                    <button class="feedback-form__button" id="add">Добавить</button>\n                </form>\n            </div>\n        </div>\'',{build:function(){e.superclass.build.call(this);const a=document.querySelector(".feedback-form__button"),t=document.querySelector(".feedback__close"),s=document.querySelector(".feedback-list");s.scrollTop=s.scrollHeight,a.addEventListener("click",e=>{e.preventDefault(),this.addFeedback()}),t.addEventListener("click",()=>{this.onCloseClick()})},clear:function(){const a=document.querySelector(".feedback-form__button"),t=document.querySelector(".feedback__close");a.removeEventListener("click",()=>{this.addFeedback()}),t.removeEventListener("click",()=>{this.onCloseClick()}),e.superclass.clear.call(this)},onCloseClick:function(){this.events.fire("userclose")},addFeedback:async function(e){const a=document.querySelector(".feedback-form__name"),t=document.querySelector(".feedback-form__location"),s=document.querySelector(".feedback-form__text"),o=new Date;let r=this._data.properties.coords,c=this._data.properties.address,d={};if(this.getData().properties._data&&(r=this._data.properties._data.coords,c=this._data.properties._data.address),""==a.value||""==t.value||""==s.value)return void alert("Заполните все поля!");try{storage.data=JSON.stringify({coords:r,address:c,name:a.value,location:t.value,feedback:s.value,date:o.toLocaleDateString()+" "+o.toLocaleTimeString()})}catch(e){console.error("Не удалось сохранить данные")}let n=JSON.parse(storage.data||"{}");feedbackArray.push(n),console.log("data",n),this.getData().properties._data?(d=this.getData().properties._data.feedbackArray,console.log("адрес",c)):d=this.getData().properties.feedbackArray,d.push({address:c,name:n.name,location:n.location,feedback:n.feedback,date:n.date}),await this.setData({properties:{address:c,coords:r,feedbackArray:d}}),a.value="",t.value="",s.value="",this.addPoint()},addPoint:function(e){const t=this._data.properties.coords,o=this._data.properties.address;feedbackArray.forEach(e=>{if(e==feedbackArray[feedbackArray.length-1]){const r=new ymaps.Placemark(t,{coords:t,address:o,feedbackArray:[{name:e.name,location:e.location,feedback:e.feedback,date:e.date}]},{preset:"islands#orangeIcon"});a.geoObjects.add(r),s.add(r)}})}}),a=new ymaps.Map("map",{center:[59.94,30.32],zoom:12,controls:["zoomControl"],behaviors:["drag"]},{balloonLayout:e}),t=ymaps.templateLayoutFactory.createClass('\n    {% for item in properties.feedbackArray %}\n    <div class="cluster">\n        <div class="cluster__header">\n            <div class="cluster__location">$[item.location]</div>\n            <div class="cluster__address"><a class="search_by_address">$[properties.address]</a></div>\n        </div>\n        <div class="cluster__feedback">$[item.feedback]</div>\n        <div class="cluster__date">$[item.date]</div>\n    </div> \n    {% endfor %}\n    '),s=new ymaps.Clusterer({preset:"islands#invertedOrangeClusterIcons",clusterBalloonContentLayout:"cluster#balloonCarousel",balloonLayout:"islands#balloon",clusterBalloonItemContentLayout:t,clusterBalloonPanelMaxMapArea:0,clusterBalloonPagerSize:5,groupByCoordinates:!1,clusterDisableClickZoom:!0,clusterHideIconOnBalloonOpen:!1});a.geoObjects.add(s),a.events.add("click",(function(e){const t=e.get("coords");ymaps.geocode(t).then((function(e){const s=e.geoObjects.get(0);let o={};o.coords=t,o.address=s.properties.get("text"),o.feedback=[],a.balloon.open(t,{properties:{coords:o.coords,address:o.address,feedbackArray:o.feedback}})}))})),document.addEventListener("click",e=>{let t=e.target,s=[];"search_by_address"===t.className&&(e.preventDefault(),feedbackArray.forEach(e=>{t.text===e.address&&(s.push(e),coords=e.coords,address=e.address),e==feedbackArray[feedbackArray.length-1]&&a.balloon.open(coords,{properties:{address:address,coords:coords,feedbackArray:s}})}))})}