ymaps.ready(init);let storage=localStorage,feedbackArray=[];function init(){const e=ymaps.templateLayoutFactory.createClass('\n        <div class="feedback">\n            <header class="feedback__header">\n                <div class="feedback__geo"><img src="img/location.png" alt="location"></div>\n                <div class="feedback__address">$[properties.address]</div>\n                <button class="feedback__close"><img src="img/close.png" alt="close"></img></button>\n            </header>\n            <div class="feedback-content">\n                <div class="feedback-list">\n                    {% if (properties.feedbackArray.length == 0) %}\n                        <div class="feedback__text feedback__none">Отзывов пока нет...</div>\n                    {% else %}\n                        <ul>\n                        {% for item in properties.feedbackArray %}\n                            <li>\n                                <span class="feedback__name">$[item.name]</span>\n                                <span class="feedback__location">$[item.location]</span>\n                                <span class="feedback__date">$[item.date]</span>\n                                <div class="feedback__text">$[item.feedback]</div>\n                            </li>\n                        {% endfor %}\n                        </ul>\n                    {% endif %}\n                </div>\n                <form class="feedback-form" action="#">\n                    <h1 class="feedback-form__title">ВАШ ОТЗЫВ</h1>\n                    <input type="text" class="feedback-form__input feedback-form__name" placeholder="Ваше имя">\n                    <input type="text" class="feedback-form__input feedback-form__location" placeholder="Укажите место">\n                    <textarea class="feedback-form__input feedback-form__text" rows="6" placeholder="Поделитесь впечатлениями"></textarea>\n                    <button class="feedback-form__button" id="add">Добавить</button>\n                </form>\n            </div>\n        </div>\'',{build:function(){e.superclass.build.call(this),this._element=this.getParentElement().querySelector(".feedback"),this.applyElementOffset();const a=document.querySelector(".feedback-form__button"),t=document.querySelector(".feedback__close"),s=document.querySelector(".feedback-list");s.scrollTop=s.scrollHeight,a.addEventListener("click",e=>{e.preventDefault(),this.addFeedback()}),t.addEventListener("click",()=>{this.onCloseClick()})},clear:function(){const a=document.querySelector(".feedback-form__button"),t=document.querySelector(".feedback__close");a.removeEventListener("click",()=>{this.addFeedback()}),t.removeEventListener("click",()=>{this.onCloseClick()}),e.superclass.clear.call(this)},applyElementOffset:function(){this._element.style.left=this._element.offsetLeft+"px",this._element.style.top=this._element.offsetTop+"px"},onCloseClick:function(){this.events.fire("userclose")},getShape:function(){if(!this._element)return e.superclass.getShape.call(this);var a=getComputedStyle(this._element),t={left:parseFloat(a.left),top:parseFloat(a.top)};return new ymaps.shape.Rectangle(new ymaps.geometry.pixel.Rectangle([[t.left,t.top],[t.left+this._element.offsetWidth,t.top+this._element.offsetHeight]]))},addFeedback:async function(e){const a=document.querySelector(".feedback-form__name"),t=document.querySelector(".feedback-form__location"),s=document.querySelector(".feedback-form__text"),r=new Date;let o=this._data.properties.coords,d=this._data.properties.address,c={};if(this.getData().properties._data&&(this.getData().properties._data.point?(this.getData().properties._data.feedbackArray=[],o=this.getData().properties._data.point.reverse(),d=this._data.properties._data.address):(o=this._data.properties._data.coords,d=this._data.properties._data.address)),""==a.value||""==t.value||""==s.value)return void alert("Заполните все поля!");try{storage.data=JSON.stringify({coords:o,address:d,name:a.value,location:t.value,feedback:s.value,date:r.toLocaleDateString()+" "+r.toLocaleTimeString()})}catch(e){console.error("Не удалось сохранить данные")}let n=JSON.parse(storage.data||"{}");feedbackArray.push(n),storage.feedbackArray=JSON.stringify(feedbackArray),c=this.getData().properties._data?this.getData().properties._data.feedbackArray:this.getData().properties.feedbackArray,c.push({address:d,name:n.name,location:n.location,feedback:n.feedback,date:n.date}),await this.setData({properties:{address:d,coords:o,feedbackArray:c}}),a.value="",t.value="",s.value="",this.addPoint()},addPoint:function(e){const t=this._data.properties.coords,r=this._data.properties.address;feedbackArray.forEach(e=>{if(e==feedbackArray[feedbackArray.length-1]){const o=new ymaps.Placemark(t,{coords:t,address:r,feedbackArray:[{name:e.name,location:e.location,feedback:e.feedback,date:e.date}]},{preset:"islands#orangeIcon"});a.geoObjects.add(o),s.add(o)}})}}),a=new ymaps.Map("map",{center:[59.94,30.32],zoom:12,controls:["zoomControl"],behaviors:["drag"]},{balloonLayout:e}),t=ymaps.templateLayoutFactory.createClass('\n    {% for item in properties.feedbackArray %}\n    <div class="cluster">\n        <div class="cluster__header">\n            <div class="cluster__location">$[item.location]</div>\n            <div class="cluster__address"><a class="search_by_address">$[properties.address]</a></div>\n        </div>\n        <div class="cluster__feedback">$[item.feedback]</div>\n        <div class="cluster__date">$[item.date]</div>\n    </div> \n    {% endfor %}\n    '),s=new ymaps.Clusterer({preset:"islands#invertedOrangeClusterIcons",clusterBalloonContentLayout:"cluster#balloonCarousel",balloonLayout:"islands#balloon",clusterBalloonItemContentLayout:t,clusterBalloonPanelMaxMapArea:0,clusterBalloonPagerSize:5,groupByCoordinates:!1,clusterDisableClickZoom:!0,clusterHideIconOnBalloonOpen:!1});storage.feedbackArray&&(feedbackArray=JSON.parse(storage.feedbackArray||"[]"),feedbackArray.forEach(e=>{const t=new ymaps.Placemark(e.coords,{coords:e.coords,address:e.address,feedbackArray:[{name:e.name,location:e.location,feedback:e.feedback,date:e.date}]},{preset:"islands#orangeIcon"});a.geoObjects.add(t),s.add(t)})),a.geoObjects.add(s),a.events.add("click",(function(e){const t=e.get("coords");ymaps.geocode(t).then((function(e){const s=e.geoObjects.get(0);let r={};r.coords=t,r.address=s.properties.get("text"),r.feedback=[],a.balloon.open(t,{properties:{coords:r.coords,address:r.address,feedbackArray:r.feedback}})}))})),document.addEventListener("click",e=>{let t=e.target,s=[];"search_by_address"===t.className&&(e.preventDefault(),feedbackArray.forEach(e=>{t.text===e.address&&(s.push(e),coords=e.coords,address=e.address),e==feedbackArray[feedbackArray.length-1]&&a.balloon.open(coords,{properties:{address:address,coords:coords,feedbackArray:s}})}))})}